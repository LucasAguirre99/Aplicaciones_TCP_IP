version: "3.9"
services:
  emqx:
    user: root
    build: ./emqx
    ports:
      - "18083:18083"
      - "1883:1883"
      - "8883:8883"
    volumes:
      - ./emqx/data/data:/opt/emqx/data
      - ./emqx/data/log:/opt/emqx/log
      #- ./emqx/config/emqx_auth_mysql.conf:/opt/emqx/etc/plugins/emqx_auth_mysql.conf

  influxdb:
    build: ./influxdb
    ports: 
      - "8086:8086"
    volumes:
      - ./influxdb/data/data:/var/lib/influxdb2
      - ./influxdb/data/config:/etc/influxdb2
  
  telegraf:
    build: ./telegraf
    deploy:
      restart_policy:
        condition: on-failure
        delay: 10s
        max_attempts: 20
    volumes:
      - ./telegraf/data/telegraf.conf:/etc/telegraf/telegraf.conf
      - ./seguridad/certs/:/etc/telegraf/certs/

  mysql:
    build: ./mysql
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql

  grafana:
    user: root
    build: ./grafana
    ports:
      - "3000:3000"
    volumes:
      - ./grafana/data:/var/lib/grafana
    secrets:
      - source: grafana_admin_password
        target: /run/secrets/admin_password

  streamlit:
    build: ./streamlitapp
    ports:
      - "8501:8501"
    environment:
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=labtcpip-iotdata-auth-token
      - INFLUXDB_ORG=labiot2024
      - INFLUXDB_BUCKET=iotdata
secrets:
  grafana_admin_password:
    file: ./grafana/secrets/grafana_admin_password